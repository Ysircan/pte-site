<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Listening · WFD</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { --bg:#f4f6f9; --card:#fff; --ink:#0b1220; --muted:#6b7280; --brand:#0f62fe }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);color:var(--ink)}
  nav{background:#0b1220;color:#fff;padding:14px 20px;display:flex;gap:28px;justify-content:center}
  nav a{color:#fff;text-decoration:none;font-weight:600;opacity:.9} nav a:hover{opacity:1}
  main{max-width:980px;margin:32px auto;padding:0 20px}
  h1{margin:0 0 8px 0;font-size:40px}
  .muted{color:var(--muted);margin:6px 0 14px}

  .toolbar{display:flex;flex-wrap:wrap;gap:10px;margin:12px 0 18px}
  .tab{border:1px solid #e5e7eb;background:#fff;border-radius:999px;padding:10px 16px;cursor:pointer;font-weight:600}
  .tab.active{background:#0b1220;color:#fff;border-color:#0b1220}

  .card{background:var(--card);border-radius:16px;padding:18px;box-shadow:0 10px 24px rgba(0,0,0,.08)}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  button{padding:10px 16px;border:0;border-radius:10px;background:#111827;color:#fff;cursor:pointer;font-weight:700}
  button.ghost{background:#e5e7eb;color:#111827}
  audio{width:100%}

  #prompt{margin:14px 0 0 0;font-size:22px;line-height:1.7}
  .input-blank{width:100px;max-width:28vw;padding:8px;font-size:18px;margin:0 6px}
  input.full{width:100%;padding:12px 14px;border:1px solid #e5e7eb;border-radius:12px;margin:12px 0;font-size:18px}

  #result{margin-top:10px;font-weight:700}
  #result .answer{color:#065f46}

  #questionNav{margin-top:22px}
  #questionNav .title{font-weight:800;margin-bottom:8px}
  #questionNav .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:8px}
  @media (max-width:720px){ #questionNav .grid{grid-template-columns:repeat(8,1fr)} }
  #questionNav button{height:36px;border-radius:8px;font-weight:800;cursor:pointer;position:relative;overflow:visible}

  /* 进度条样式（保留） */
  .progress {height:8px;background:#e5e7eb;border-radius:999px;margin-top:10px;overflow:hidden}
  .progress > span{display:block;height:100%;transition:width .25s ease}
  #pgInfo{font-size:12px;margin-top:6px;color:#6b7280}

  /* FULL 模式缺词标红（保留） */
  mark.miss { color:#e11d48; background:transparent; font-weight:700; }

  /* ————— 🌟 满贯“整圈金框 + 流动高光”（常驻，直到 reset） ————— */

  @property --flow-pos { syntax: '<percentage>'; inherits: false; initial-value: 0%; }

  /* 金框类：仅隐藏原边框；不改变原背景/文字颜色（不遮号） */
  #qGrid button.gold-frame {
    border-color: transparent !important;
  }

  /* 实体金框（常亮） */
  #qGrid button.gold-frame::before{
    content:"";
    position:absolute;
    inset:-3px;
    border-radius:10px;
    padding:3px;
    background: linear-gradient(90deg,#f59e0b,#fbbf24,#fde68a,#facc15,#f59e0b);
    background-size: 200% 100%;
    -webkit-mask:
      linear-gradient(#000 0 0) content-box,
      linear-gradient(#000 0 0);
    -webkit-mask-composite: xor;
            mask-composite: exclude;
    pointer-events:none;
  }

  /* 流动高光纹理（覆盖在金框上，整体流动） */
  #qGrid button.gold-frame::after{
    content:"";
    position:absolute;
    inset:-3px;
    border-radius:10px;
    padding:3px;
    background:
      linear-gradient(90deg,
        rgba(255,255,255,0) 0%,
        rgba(255,255,255,0.35) 25%,
        rgba(255,255,255,0.65) 50%,
        rgba(255,255,255,0.35) 75%,
        rgba(255,255,255,0) 100%);
    background-size: 200% 100%;
    background-position: var(--flow-pos) 0%;
    mix-blend-mode: screen;
    -webkit-mask:
      linear-gradient(#000 0 0) content-box,
      linear-gradient(#000 0 0);
    -webkit-mask-composite: xor;
            mask-composite: exclude;
    animation: goldFlowMove 3.2s linear infinite;
    pointer-events:none;
  }

  @keyframes goldFlowMove { to { --flow-pos: 100%; } }

  /* 首次达成轻微脉冲（一次） */
  @keyframes starPulse {
    0%   { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.0); }
    50%  { box-shadow: 0 0 12px 4px rgba(250, 204, 21, 0.55); }
    100% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.0); }
  }
  #qGrid button.gold-frame.celebrate { animation: starPulse 0.6s ease-in-out 3; }

  /* 减少动态：金框常亮但不流动不脉冲 */
  @media (prefers-reduced-motion: reduce) {
    #qGrid button.gold-frame::after { animation: none; }
    #qGrid button.gold-frame.celebrate { animation: none; }
  }
</style>
</head>
<body>
<nav>
  <a href="../../index.html">Home</a>
  <a href="../../speaking/index.html">Speaking</a>
  <a href="../../writing/index.html">Writing</a>
  <a href="../../reading/index.html">Reading</a>
  <a href="../../listening/index.html">Listening</a>
</nav>

<main>
  <h1>Listening · WFD</h1>
  <div class="muted">Choose a mode to start practicing.</div>

  <!-- 模式 Tab -->
  <div class="toolbar" id="tabs">
    <div class="tab active" data-mode="fw">Function Words</div>
    <div class="tab" data-mode="cw">Content Words</div>
    <div class="tab" data-mode="full">Full Sentence</div>
  </div>

  <!-- 练习卡片 -->
  <div class="card">
    <audio id="audio" controls></audio>

    <div id="prompt"></div>
    <div id="inputs"></div>

    <div class="row">
      <button class="ghost" id="prevBtn">Prev</button>
      <button id="checkBtn">Check</button>
      <button class="ghost" id="showBtn">Show Answer</button>
      <button class="ghost" id="resetBtn">Reset</button>
      <button class="ghost" id="nextBtn">Next</button>
    </div>

    <div class="progress"><span id="pgBar"></span></div>
    <div id="pgInfo" class="muted"></div>

    <div id="result"></div>
  </div>

  <!-- 题号导航 -->
  <div id="questionNav">
    <div class="title" id="navTitle">Question Navigator</div>
    <div class="grid" id="qGrid"></div>
  </div>
</main>

<!-- 题库文件（与本页同目录） -->
<script src="./data-fw.js"></script>
<script src="./data-cw.js"></script>
<script src="./data-full.js"></script>

<script>
/* 音频根目录：wfd.html 在 listening/wfd/；音频在 listening/audio/ */
const AUDIO_BASE = "../audio/";

/* —— 状态 —— */
let mode = "fw";       // fw | cw | full
let list = [];
let idx  = 0;

const $ = s => document.querySelector(s);

/* 规范化与分词 */
const norm = s => (s||"").trim().toLowerCase()
  .replace(/[.,!?;:"'’”“()[\]]/g,"").replace(/\s+/g," ");
const resultKey = (m,id) => `wfd_${m}_result_${id}`;
const countHoles = s => ((s||"").match(/___/g) || []).length;

/* FULL 词频 */
const wordOnlyTokens = s => (s||"").toLowerCase().match(/[a-z']+/g) || [];
const freqMap = tokens => { const m=new Map(); for(const t of tokens)m.set(t,(m.get(t)||0)+1); return m; };

/* —— 工具：根据 id 定位 / 每模式记忆 idx —— */
const lastIdxKey = m => `wfd_last_idx_${m}`;

function findIndexById(arr, id) {
  if (!id || !arr || !arr.length) return -1;
  return arr.findIndex(x => String(x.id) === String(id));
}

function rememberIdx() {
  const item = list[idx];
  if (!item) return;
  localStorage.setItem(lastIdxKey(mode), String(idx));
}

function restoreIdxForMode(m, arr, fallbackId) {
  // 1) 优先：同题 id
  if (fallbackId) {
    const k = findIndexById(arr, fallbackId);
    if (k >= 0) return k;
  }
  // 2) 其次：该模式上次停留 idx
  const saved = localStorage.getItem(lastIdxKey(m));
  const k = Number.isInteger(+saved) ? +saved : 0;
  if (k >= 0 && k < arr.length) return k;
  // 3) 否则：0
  return 0;
}

function judgeFULL(answerText, userText){
  const need = freqMap(wordOnlyTokens(answerText));
  const have = freqMap(wordOnlyTokens(userText));
  for (const [w, cnt] of need.entries()) if ((have.get(w) || 0) < cnt) return false;
  return true;
}

/* Show Answer 缺词标红 */
const wordTokens = s => (s.match(/[A-Za-z']+|[^A-Za-z']+/g) || []);
function highlightMissingInAnswer(answerText, userText){
  const need = freqMap(wordOnlyTokens(answerText));
  const have = freqMap(wordOnlyTokens(userText));
  const seen = new Map();
  return (wordTokens(answerText)).map(tok=>{
    if(!/^[A-Za-z']+$/.test(tok)) return tok;
    const key = tok.toLowerCase();
    const totalNeed = need.get(key) || 0;
    if (!totalNeed) return tok;
    const k = (seen.get(key) || 0) + 1; seen.set(key,k);
    const haveCnt = have.get(key) || 0;
    return (k>haveCnt) ? `<mark class="miss">${tok}</mark>` : tok;
  }).join('');
}

/* FW/CW：独立词匹配（多写不罚） */
function escapeRegExp(s){ return (s||'').replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
function findWordMatch(hay, needle){
  const re = new RegExp(`\\b${escapeRegExp(needle)}\\b`, 'i');
  const m = (hay || '').match(re);
  return m ? m[0] : null;
}

/* —— 解锁进度（保留，以驱动进度条） —— */
const unlockKey = id => `wfd_unlock_${id}`;
function getUnlockedSet(id){
  try{ const arr = JSON.parse(localStorage.getItem(unlockKey(id))||"[]"); return new Set(arr.map(x=>String(x).toLowerCase())); }
  catch{ return new Set(); }
}
function saveUnlockedSet(id,set){ localStorage.setItem(unlockKey(id), JSON.stringify([...set])); }
function addUnlockedWords(id, words){
  const s = getUnlockedSet(id);
  words.forEach(w=>{ if(w) s.add(String(w).toLowerCase()); });
  saveUnlockedSet(id, s);
}

/* 🌟 满贯判定、庆祝与“常驻金框”持久化 */
const starCelebrateKey = id => `wfd_star_celebrated_${id}`; // 首次脉冲已播
const starPersistKey   = id => `wfd_star_persist_${id}`;     // 常驻金框标记（1=常驻）

function hasLiveFullPass(id){
  const fw   = localStorage.getItem(resultKey('fw',   id));
  const cw   = localStorage.getItem(resultKey('cw',   id));
  const full = localStorage.getItem(resultKey('full', id));
  return fw === 'correct' && cw === 'correct' && full === 'correct';
}

/* 进度条（保留） */
function renderProgress(){
  const item = list[idx]; if(!item) return;
  const unlocked = getUnlockedSet(item.id);
  const total = wordTokens(item.answer).filter(w=>/^[A-Za-z']+$/.test(w)).length || 1;
  const done = unlocked.size;
  const pct = Math.min(100, Math.round(done*100/total));
  $("#pgBar").style.width = pct + "%";
  $("#pgBar").style.background = pct >= 100 ? "#10b981" : "#0f62fe";
  $("#pgInfo").textContent = `Progress: ${done}/${total} (${pct}%)`;
}

/* Tab */
$("#tabs").addEventListener("click", e=>{
  const t = e.target.closest(".tab"); if(!t) return;

  // 记录当前题目的 id，供切换后对齐
  const currentItem = list[idx];
  const currentId = currentItem ? currentItem.id : null;

  // 切换模式
  mode = t.dataset.mode;
  [...$("#tabs").children].forEach(x=>x.classList.toggle("active", x===t));

  // 重建列表，但按同题 id / 记忆 idx 还原题号
  rebuild(currentId);
});

/* 按钮 */
$("#checkBtn").addEventListener("click", onCheck);
$("#showBtn").addEventListener("click", onShow);
$("#resetBtn").addEventListener("click", onResetAll);
$("#prevBtn").addEventListener("click", ()=>{
  if(!list.length) return;
  idx=(idx-1+list.length)%list.length;
  rememberIdx();
  render(); renderNav();
});
$("#nextBtn").addEventListener("click", ()=>{
  if(!list.length) return;
  idx=(idx+1)%list.length;
  rememberIdx();
  render(); renderNav();
});

/* 载入题库 */
function rebuild(fallbackId=null){
  const MAP = { fw: (window.DATA_FW||[]), cw: (window.DATA_CW||[]), full: (window.DATA_FULL||[]) };
  list = MAP[mode] || [];
  idx = restoreIdxForMode(mode, list, fallbackId);

  if(!list.length) renderEmpty(); else render();
  renderNav();
}

/* 空态 */
function renderEmpty(){
  $("#audio").src = "";
  $("#prompt").textContent = "";
  $("#inputs").innerHTML = "";
  $("#result").innerHTML = `<span style="color:#b45309">No items found.</span>`;
  $("#navTitle").textContent = "Question Navigator · 0 items";
  $("#qGrid").innerHTML = "";
  renderProgress();
}

/* 渲染题面 */
function render(){
  $("#result").textContent = "";
  const item = list[idx]; if(!item) return renderEmpty();

  $("#audio").src = AUDIO_BASE + (item.audio || "");
  $("#prompt").textContent = item.prompt || "";
  $("#inputs").innerHTML = "";

  if (mode === "full") {
    const input = document.createElement("input");
    input.type = "text";
    input.placeholder = "Type what you hear...";
    input.className = "full";
    $("#inputs").appendChild(input);
  } else {
    const wrap = document.createElement("div");
    const holes = countHoles(item.prompt || "");
    const n = holes > 0 ? holes : (item.blanks || []).length;
    for (let i = 0; i < n; i++){
      const inp = document.createElement("input");
      inp.type = "text";
      inp.className = "input-blank";
      wrap.appendChild(inp);
    }
    $("#inputs").appendChild(wrap);
  }

  renderProgress();
}

/* 导航：原状态色 + 金框常驻（基于持久标记），新达成即写入并脉冲一次 */
function renderNav(){
  const N = list.length;
  $("#navTitle").textContent = `Question Navigator · ${N} item${N>1?'s':''}`;
  const grid = $("#qGrid");
  grid.innerHTML = "";

  list.forEach((item, i) => {
    const state = localStorage.getItem(resultKey(mode, item.id)); // correct | wrong | warn
    let border="#ccc", bg="#f4f4f4", col="#333";
    if (i===idx){ border="#0f62fe"; bg="#e6f0ff"; col="#0f62fe"; }
    else if (state==="correct"){ border="#28a745"; bg="#e6f9ec"; col="#28a745"; }
    else if (state==="warn"){ border="#b45309"; bg="#fff8e1"; col="#b45309"; }
    else if (state==="wrong"){ border="#dc3545"; bg="#fdecea"; col="#dc3545"; }

    const btn=document.createElement("button");
    btn.textContent=i+1;
    btn.style.border=`2px solid ${border}`;
    btn.style.background=bg;
    btn.style.color=col;

    // 若本题尚未常驻金框，但“当前实时状态”首次达到满贯 → 写入常驻标记，并触发一次脉冲
    const persisted = localStorage.getItem(starPersistKey(item.id)) === '1';
    if (!persisted && hasLiveFullPass(item.id)) {
      localStorage.setItem(starPersistKey(item.id), '1');
      // 记录已庆祝，避免重复
      if (localStorage.getItem(starCelebrateKey(item.id)) !== '1') {
        btn.classList.add('celebrate');
        btn.addEventListener('animationend', () => {
          btn.classList.remove('celebrate');
          localStorage.setItem(starCelebrateKey(item.id), '1');
        }, { once: true });
      }
    }

    // 只要常驻标记存在，就显示金框（无论当前是否仍然满足满贯）
    if (localStorage.getItem(starPersistKey(item.id)) === '1') {
      btn.classList.add('gold-frame');
    }

    btn.addEventListener("click",()=>{
      idx=i;
      rememberIdx();
      render();
      renderNav();
    });
    grid.appendChild(btn);
  });
}

/* 首字母大小写检测（非阻断） */
function firstLetterCaseMismatch(userStr, ansStr){
  const um = (userStr || "").match(/[A-Za-z]/);
  const am = (ansStr  || "").match(/[A-Za-z]/);
  if (!um || !am) return false;
  const uc = um[0], ac = am[0];
  if (uc.toLowerCase() !== ac.toLowerCase()) return false;
  return uc !== ac;
}

/* 判题 */
function onCheck(){
  const item = list[idx]; if (!item) return;
  $("#inputs").querySelectorAll(".mark").forEach(m=>m.remove());

  if (mode === "full") {
    const input = $("#inputs input.full");
    const user = (input.value || "").trim();
    const ans  = (item.answer || "").trim();

    const pass = judgeFULL(ans, user);
    if (pass) {
      if (firstLetterCaseMismatch(user, ans)) {
        $("#result").innerHTML = "⚠️ Spelling correct, but check capitalization of the first letter.";
        localStorage.setItem(resultKey(mode, item.id), "warn");
      } else {
        $("#result").textContent = "✅ Correct";
        localStorage.setItem(resultKey(mode, item.id), "correct");
      }
    } else {
      $("#result").textContent = "❌ Try again";
      localStorage.setItem(resultKey(mode, item.id), "wrong");
    }

  } else {
    // FW / CW：包含目标词即可（多写不罚；独立词边界）
    const ins = [...$("#inputs").querySelectorAll("input.input-blank")];
    const expected = (item.blanks || []);
    const answers = expected.slice(0, ins.length);
    while (answers.length < ins.length) answers.push("");

    let allOK = true, anyWarn = false;
    const toUnlock = [];

    ins.forEach((inp, k)=>{
      const user = (inp.value || "").trim();
      const ans  = (answers[k] || "").trim();

      const matched = findWordMatch(user, ans);
      const ok = !!matched;
      const warn = ok && firstLetterCaseMismatch(matched, ans);

      if (ok) toUnlock.push(ans);

      const mark = document.createElement("span");
      mark.className = "mark";
      mark.style.marginLeft = "6px";
      mark.style.fontWeight = "bold";

      if (ok && !warn) { mark.style.color = "green"; mark.textContent = "✔"; }
      else if (ok && warn){ mark.style.color = "#b45309"; mark.textContent = "!"; anyWarn = true; }
      else { mark.style.color = "red"; mark.textContent = "✘"; allOK = false; }

      inp.after(mark);
    });

    if (toUnlock.length) addUnlockedWords(item.id, toUnlock);
    renderProgress();

    if (allOK) {
      $("#result").textContent = "✅ All blanks correct!";
      localStorage.setItem(resultKey(mode, item.id), "correct");
    } else if (!allOK && anyWarn && !ins.some((inp, k)=>!findWordMatch((inp.value||"").trim(), (answers[k]||"").trim()))) {
      $("#result").innerHTML = "⚠️ Spelling correct, but check capitalization (first letter).";
      localStorage.setItem(resultKey(mode, item.id), "warn");
    } else {
      $("#result").textContent = "❌ Some blanks are wrong";
      localStorage.setItem(resultKey(mode, item.id), "wrong");
    }
  }

  rememberIdx();
  renderNav(); // 评判后立即刷新导航（若首次满贯则落库并显示金框）
}

/* 看答案 */
function onShow(){
  const item = list[idx]; if (!item) return;
  if (mode === "full") {
    const input = $("#inputs input.full");
    const user = (input?.value || "").trim();
    const highlighted = highlightMissingInAnswer(item.answer || "", user || "");
    $("#result").innerHTML = `Answer: <span class="answer">${highlighted}</span>`;
  } else {
    $("#result").innerHTML = `Answer: <span class="answer">${item.answer}</span>`;
  }
}

/* 重置（清掉本模式记录 & 常驻金框标记 & 脉冲记录） */
function onResetAll(){
  list.forEach(item=>{
    localStorage.removeItem(resultKey(mode, item.id));
    localStorage.removeItem(starPersistKey(item.id));   // ← 仅 Reset 时才移除常驻金框
    localStorage.removeItem(starCelebrateKey(item.id)); // 允许下次再次脉冲
  });
  localStorage.removeItem(lastIdxKey(mode)); // 清除该模式的“上次题号”记忆
  idx = 0;
  render();
  renderNav();
  $("#result").textContent = "";
  renderProgress();
}

/* 启动 */
rebuild();
</script>
</body>
</html>
